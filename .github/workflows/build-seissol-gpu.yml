# SPDX-FileCopyrightText: 2024 SeisSol Group
#
# SPDX-License-Identifier: BSD-3-Clause
# SPDX-LicenseComments: Full text under /LICENSE and /LICENSES/
#
# SPDX-FileContributor: Author lists in /AUTHORS and /CITATION.cff

name: build-seissol-gpu
on:
  - push

env:
  precomputed-hash: 57577066fddab59afc5670397549b1b3e6d6e7ac

jobs:
  seissol-build-test:
    name: seissol-build-test<${{matrix.setup.cc}}, ${{matrix.setup.backend}}, ${{matrix.setup.arch}}, ${{matrix.build_type}}>
    runs-on: ubuntu-24.04
    container: ${{ matrix.setup.container }}
    continue-on-error: true
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        arch:
          - snb # <-- needed for the self-hosted CI node for now :/
        build_type:
          - Release
          #- Debug
        setup:
          - cc: gcc-13
            cxx: g++-13
            fc: gfortran-13
            container: seissol/gha-gpu-nv:davschneller-ci-merge
            arch: sm_60
            backend: cuda
          - cc: clang-19
            cxx: clang++-19
            fc: flang-19
            container: seissol/gha-gpu-nv:davschneller-ci-merge
            arch: sm_60
            backend: cuda
          - cc: gcc-13
            cxx: g++-13
            fc: gfortran-13
            container: seissol/gha-gpu-nv:davschneller-ci-merge
            arch: sm_60
            backend: acpp
          - cc: gcc-13
            cxx: g++-13
            fc: gfortran-13
            container: seissol/gha-gpu-amd:davschneller-ci-merge
            arch: gfx906
            backend: hip
          - cc: clang-19
            cxx: clang++-19
            fc: flang-19
            container: seissol/gha-gpu-amd:davschneller-ci-merge
            arch: gfx906
            backend: hip
          - cc: gcc-13
            cxx: g++-13
            fc: gfortran-13
            container: seissol/gha-gpu-amd:davschneller-ci-merge
            arch: gfx906
            backend: acpp
          - cc: icx
            cxx: icpx
            fc: ifx
            container: seissol/gha-gpu-intel-2025:davschneller-ci-merge
            mpi: intel
            arch: skl
            backend: oneapi
          - cc: nvc
            cxx: nvc++
            fc: nvfortran
            container: seissol/gha-gpu-nvhpc:davschneller-ci-merge
            arch: sm_60
            backend: cuda
    steps:
      - name: checkout-seissol
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/cpu-build
        name: elastic-s-p6
        if: ${{ !cancelled() }}
        with:
          cfg-order: 6
          cfg-equation: elastic
          cfg-mechanisms: 0
          cfg-precision: single
          cfg-simulations: 1
          hostarch: ${{matrix.arch}}
          buildtype: ${{matrix.build_type}}
          cc: ${{matrix.setup.cc}}
          cxx: ${{matrix.setup.cxx}}
          fc: ${{matrix.setup.fc}}
          devicearch: ${{matrix.setup.arch}}
          devicebackend: ${{matrix.setup.backend}}
          tests: OFF
 
      - uses: ./.github/actions/cpu-build
        name: viscoelastic-3-s-p6
        if: ${{ !cancelled() }}
        with:
          cfg-order: 6
          cfg-equation: viscoelastic2
          cfg-mechanisms: 3
          cfg-precision: single
          cfg-simulations: 1
          hostarch: ${{matrix.arch}}
          buildtype: ${{matrix.build_type}}
          cc: ${{matrix.setup.cc}}
          cxx: ${{matrix.setup.cxx}}
          fc: ${{matrix.setup.fc}}
          devicearch: ${{matrix.setup.arch}}
          devicebackend: ${{matrix.setup.backend}}
          tests: OFF
      
      - uses: ./.github/actions/cpu-build
        name: anisotropic-s-p6
        if: ${{ !cancelled() }}
        with:
          cfg-order: 6
          cfg-equation: anisotropic
          cfg-mechanisms: 0
          cfg-precision: single
          cfg-simulations: 1
          hostarch: ${{matrix.arch}}
          buildtype: ${{matrix.build_type}}
          cc: ${{matrix.setup.cc}}
          cxx: ${{matrix.setup.cxx}}
          fc: ${{matrix.setup.fc}}
          devicearch: ${{matrix.setup.arch}}
          devicebackend: ${{matrix.setup.backend}}
          tests: OFF
      
      - uses: ./.github/actions/cpu-build
        name: acoustic-s-p6
        if: ${{ !cancelled() }}
        with:
          cfg-order: 6
          cfg-equation: acoustic
          cfg-mechanisms: 0
          cfg-precision: single
          cfg-simulations: 1
          hostarch: ${{matrix.arch}}
          buildtype: ${{matrix.build_type}}
          cc: ${{matrix.setup.cc}}
          cxx: ${{matrix.setup.cxx}}
          fc: ${{matrix.setup.fc}}
          devicearch: ${{matrix.setup.arch}}
          devicebackend: ${{matrix.setup.backend}}
          tests: OFF
      
      - uses: ./.github/actions/cpu-build
        name: elastic-s-p3-f32
        if: ${{ !cancelled() }}
        with:
          cfg-order: 3
          cfg-equation: elastic
          cfg-mechanisms: 0
          cfg-precision: single
          cfg-simulations: 32
          hostarch: ${{matrix.arch}}
          buildtype: ${{matrix.build_type}}
          cc: ${{matrix.setup.cc}}
          cxx: ${{matrix.setup.cxx}}
          fc: ${{matrix.setup.fc}}
          devicearch: ${{matrix.setup.arch}}
          devicebackend: ${{matrix.setup.backend}}
          tests: OFF

      - name: upload-seissol
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: seissol-${{matrix.build_type}}-${{matrix.precision}}-${{matrix.setup.arch}}-${{matrix.setup.backend}}-${{matrix.equation.order}}-${{matrix.equation.type}}-${{matrix.setup.cc}}
          path: /opt/seissol

  seissol-run-test:
    name: seissol-run-test
    runs-on: self-hosted
    container: ${{ matrix.setup.container }}
    continue-on-error: true
    needs: [seissol-build-test]
    if: ${{ github.repository == 'SeisSol/SeisSol' && false }}
    strategy:
      fail-fast: false
      matrix:
        case:
          # NOTE: the commented tests do not yet work on the GPU on this branch
          - name: tpv5
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpv5-nuc
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpv5-visco
            equation: viscoelastic2
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          #- name: tpv5-poro
          #  equation: poroelastic
          #  multisim: 1
          #  energies: false # incomplete, hence disabled
          #  receivers: true
          #  fault: true
          #  volume: true
          #  surface: false
          #  order: 6
          - name: tpv6
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpv13
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpv16
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpv101
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpv101-slip
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpv104
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpv105
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpvahsp
            equation: anisotropic
            multisim: 1
            energies: false
            receivers: true
            fault: false
            volume: true
            surface: false
            order: 6
          - name: tpvgaussian
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: tpvyoffe
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: false
            order: 6
          - name: ttpv1
            equation: elastic
            multisim: 1
            energies: true
            receivers: true
            fault: true
            volume: true
            surface: true
            order: 6
          - name: tpvloh1-fused
            equation: elastic
            multisim: 32
            energies: true
            receivers: true
            fault: false # NYI
            volume: false
            surface: false
            order: 3
        precision:
          - single
        arch:
          - hsw
        build_type:
          - Release
        setup:
          - cc: gcc-13
            cxx: g++-13
            fc: gfortran-13
            container: seissol/gha-gpu-nv:davschneller-ci-merge
            arch: sm_60
            backend: cuda
            mpi: openmpi
          - cc: clang-19
            cxx: clang++-19
            fc: flang-19
            container: seissol/gha-gpu-nv:davschneller-ci-merge
            arch: sm_60
            backend: cuda
            mpi: openmpi
          - cc: nvc
            cxx: nvc++
            fc: nvfortran
            container: seissol/gha-gpu-nvhpc:davschneller-ci-merge
            arch: sm_60
            backend: cuda
            mpi: openmpi
        parallel:
          - ranks: 1
            threads: 4
            commthread: false
          - ranks: 4
            threads: 1
            commthread: false
    steps:      
      - id: get-precomputed-solutions
        name: get-precomputed-solutions
        uses: actions/checkout@v4
        with:
          repository: seissol/precomputed-seissol
          ref: ${{env.precomputed-hash}}
          path: precomputed

      - name: get-seissol
        uses: actions/download-artifact@v4
        with:
          name: seissol-${{matrix.build_type}}-${{matrix.arch}}-${{matrix.setup.cc}}
          path: install
        
      # TODO: make this checkout obsolete
      - name: get-verification-scripts
        uses: actions/checkout@v4
        with:
          path: scripts

      - name: run-seissol
        id: run
        run: |
          if [ ${{matrix.setup.mpi}} = openmpi ]; then
            MPI_OPTIONS="--oversubscribe --allow-run-as-root";
          elif [ ${{matrix.setup.mpi}} = intel ]; then
            MPI_OPTIONS="";
          else
            MPI_OPTIONS="";
          fi;

          export PATH=$(pwd)/install/bin:$PATH
          export LD_LIBRARY_PATH=$(pwd)/install/lib:$(pwd)/install/lib64:$LD_LIBRARY_PATH

          chmod +x $(pwd)/install/bin/*
          
          export OMP_NUM_THREADS=${{matrix.parallel.threads}}
          export SEISSOL_COMMTHREAD=${{matrix.parallel.commthread}}
          export SEISSOL_MINISEISSOL=OFF

          # FIXME: compile the container with GPU-aware MPI
          export SEISSOL_USM_MPI=1

          cd precomputed

          inner()
          {
            local CONFIG=$2

            NAME=$(echo "$CONFIG" | jq -rc '.name')

            COMPARE_FAULT=$(echo "$CONFIG" | jq -rc '.compare.fault.enabled')
            COMPARE_VOLUME=$(echo "$CONFIG" | jq -rc '.compare.volume.enabled')
            COMPARE_SURFACE=$(echo "$CONFIG" | jq -rc '.compare.surface.enabled')
            COMPARE_ENERGY=$(echo "$CONFIG" | jq -rc '.compare.energies.enabled')
            COMPARE_RECEIVER=$(echo "$CONFIG" | jq -rc '.compare.receivers.enabled')
            COMPARE_RECEIVER_MODE=$(echo "$CONFIG" | jq -rc '.compare.receivers.type')

            cd $NAME

            for run in $(echo "$CONFIG" | jq -rc '.[]'); do
              rm -rf output
              mpirun ${MPI_OPTIONS} -np ${{matrix.parallel.ranks}} seissol-cpu-${run}
              ERROR=$?
              if [ $ERROR == 0 ]; then
                for run in $(echo "$CONFIG" | jq -rc '.[]'); do
                  if COMPARE_FAULT then
                    python3 $SCRIPTS/compare-mesh.py ./output/${FAULT_FILE} ./precomputed/${run}/${FAULT_FILE} --epsilon ${EPSILON}
                    if [ $? != 0 ]; then
                      ERROR=1
                    fi
                  fi
                  if COMPARE_VOLUME then
                    python3 $SCRIPTS/compare-mesh.py ./output/${VOLUME_FILE} ./precomputed/${run}/${VOLUME_FILE} --epsilon ${EPSILON}
                    if [ $? != 0 ]; then
                      ERROR=1
                    fi
                  fi
                  if COMPARE_SURFACE then
                    python3 $SCRIPTS/compare-mesh.py ./output/${SURFACE_FILE} ./precomputed/${run}/${SURFACE_FILE} --epsilon ${EPSILON}
                    if [ $? != 0 ]; then
                      ERROR=1
                    fi
                  fi
                  if COMPARE_ENERGY then
                    python3 $SCRIPTS/compare-energies.py ./output/${ENERGY_FILE} ./precomputed/${run}/${ENERGY_FILE} --epsilon ${EPSILON}
                    if [ $? != 0 ]; then
                      ERROR=1
                    fi
                  fi
                  if COMPARE_RECEIVER then
                    python3 $SCRIPTS/compare-receivers.py ./output ./precomputed/${run} --epsilon ${EPSILON} --mode $COMPARE_RECEIVER_MODE
                    if [ $? != 0 ]; then
                      ERROR=1
                    fi
                  fi
                done
              fi
              exit $ERROR
            done

            cd ..
          }

          source $GITHUB_WORKSPACE/.ci/configloop.sh
          testloop inner "$GITHUB_WORKSPACE/.ci/tests.json"
