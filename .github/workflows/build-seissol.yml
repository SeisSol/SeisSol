name: build-seissol
on:
  - push

jobs:
  seissol:
    name: seissol
    runs-on: ubuntu-24.04
    container: seissol/gha-cpu:sha-44e8ec6
    strategy:
      matrix:
        build_type:
          - Release
          - Debug
        equations:
          - elastic
          - poroelastic
          - viscoelastic2
          - anisotropic
        precision:
          - single
          - double
    steps:
      - name: checkout-seissol
        uses: actions/checkout@v4

      - name: build-seissol
        run: |
          git config --global --add safe.directory '*'
          git submodule update --init
          mkdir build && cd build
          if [ "${{ matrix.equations }}" = viscoelastic2 ]; then
              mechanisms=3
          else
              mechanisms=0
          fi
          CMAKE_PREFIX_PATH=/opt/dependencies cmake .. -GNinja -DTESTING=ON -DCMAKE_BUILD_TYPE=${{matrix.build_type}} -DEQUATIONS=${{matrix.equations}} -DPRECISION=${{matrix.precision}} -DNUMBER_OF_MECHANISMS=$mechanisms
          ninja

      - name: test-seissol
        run: |
          cd build
          ninja test
